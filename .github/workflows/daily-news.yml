name: Daily News Pipeline

on:
  schedule:
    # 6 AM Pacific Time = 2 PM UTC (during PST) / 1 PM UTC (during PDT)
    # Using 2 PM UTC - will be 6 AM PST or 7 AM PDT
    - cron: '0 14 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  fetch-and-curate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Fetch news articles
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: node scripts/fetch-news.js

      - name: Curate articles with AI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: node scripts/curate-with-ai.js

      - name: Commit curated articles
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git diff --staged --quiet || git commit -m "Daily news curation - $(date +'%Y-%m-%d')"
          git push

      - name: Create notification issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“° Articles Ready for Review - ${today}`,
              body: `## Today's articles are ready!

The daily news pipeline has finished curating positive news stories.

### ðŸ‘‰ [Click here to review and approve articles](https://news-thats-not-crap.netlify.app/review.html)

Once you've reviewed:
1. **Approve** the articles you want to publish
2. **Deny** any you want to skip
3. Click **Publish** to make them live

---
*This issue was automatically created by the daily news pipeline.*
*Close this issue after publishing.*`,
              labels: ['review-needed']
            });
